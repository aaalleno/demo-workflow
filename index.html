<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2.0.0/webcomponents-loader.js"></script>
  <script src="https://www.unpkg.com/lit@2.0.0-rc.2/polyfill-support.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@n8n_io/n8n-demo-component/n8n-demo.bundled.js"></script>
</head>
<body>
  <n8n-demo workflow='{ "createdAt": "2024-09-10T15:39:52.266Z", "updatedAt": "2024-10-10T09:14:10.166Z", "id": "mPGQR5huFoxKGLyt", "name": "Score", "active": true, "nodes": [ { "parameters": { "model": "gpt-4", "options": {} }, "id": "d989fd7c-509d-44a3-9c5b-260869078ec0", "name": "Azure OpenAI Chat Model", "type": "@n8n/n8n-nodes-langchain.lmChatAzureOpenAi", "typeVersion": 1, "position": [ 2980, 580 ], "credentials": { "azureOpenAiApi": { "id": "IjmIi9MAC1gUJoY4", "name": "Azure Open AI account" } } }, { "parameters": { "aggregate": "aggregateAllItemData", "destinationFieldName": "messages", "options": {} }, "id": "cb47f94e-e6c5-400b-b421-9465f1976721", "name": "Aggregate", "type": "n8n-nodes-base.aggregate", "typeVersion": 1, "position": [ 2500, 380 ] }, { "parameters": { "updates": [ "messages" ] }, "id": "49fc1ed5-2a95-43fa-a26e-31e6c975b360", "name": "WhatsApp Trigger", "type": "n8n-nodes-base.whatsAppTrigger", "typeVersion": 1, "position": [ 960, 360 ], "webhookId": "8220ed86-dd08-40e8-8773-9491e796f96e", "credentials": { "whatsAppTriggerApi": { "id": "XLwrZRvLKNxEVPyR", "name": "WhatsApp OAuth account" } } }, { "parameters": { "options": {} }, "id": "f447fb68-dc7a-4f43-9e01-32a92055b4e9", "name": "When chat message received", "type": "@n8n/n8n-nodes-langchain.chatTrigger", "typeVersion": 1.1, "position": [ 960, 520 ], "webhookId": "28315f93-d045-4074-ab41-389ae51c1e58" }, { "parameters": {}, "id": "2c9adda0-151b-4ac2-8242-0dbeeaebbe72", "name": "Merge", "type": "n8n-nodes-base.noOp", "typeVersion": 1, "position": [ 4219, 640 ], "alwaysOutputData": false }, { "parameters": { "mode": "raw", "jsonOutput": "={\n \"messaging_product\": \"whatsapp\",\n \"recipient_type\": \"individual\",\n \"to\": \"{{ $( \'WhatsApp Trigger \').item.json.contacts[0].wa_id }}\",\n \"type\": \"interactive\",\n \"interactive\": {\n \"type\":\"button\",\n \"footer\":{\n \"text\": \"{{ ($( \'Aggregate \').isExecuted && $( \'Aggregate \').item.json.messages[0].messagesCount > 0)?\"Question \"+$( \'Aggregate \').item.json.messages[0].messages.filter(n => n.ai).length+\" - \":\"\" }}Score actuel : {{ $( \'Merge \').item.json.score}}\"\n },\n \"body\": {\n \"text\": \"{{ $( \'Merge \').item.json.question }}\"\n },\n \"action\":{{ $( \'Create actions boutons \').item.json.action.toJsonString()}}\n }\n}", "options": {} }, "id": "512546be-ab3a-4ad1-82fb-f8f9b831d5ad", "name": "set interactive body", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ 5099, 640 ] }, { "parameters": { "mode": "raw", "jsonOutput": "={\n \"messaging_product\": \"whatsapp\",\n \"recipient_type\": \"individual\",\n \"to\": \"{{ $( \'WhatsApp Trigger \').item.json.contacts[0].wa_id }}\",\n \"type\": \"text\",\n \"text\": {\n \"body\": \"{{ $( \'Merge \').item.json.question || $( \'Merge \').item.json.response }}\"\n }\n}", "options": {} }, "id": "462ba5b7-c89c-4d80-b53b-768888846b82", "name": "Set simple body", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ 4879, 840 ] }, { "parameters": { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 1 }, "conditions": [ { "id": "8a765e57-8e39-4547-a99a-0458df2b75f4", "operator": { "type": "object", "operation": "exists", "singleValue": true }, "leftValue": "={{ $json.messages[0] }}", "rightValue": "" } ], "combinator": "and" }, "options": { "looseTypeValidation": true } }, "id": "a45b5300-3127-4c97-a5bb-1d5691e7800d", "name": "Is message?", "type": "n8n-nodes-base.if", "position": [ 1120, 360 ], "typeVersion": 2 }, { "parameters": { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" }, "conditions": [ { "id": "c4b12572-2a8f-44da-84be-519465ae7dc4", "leftValue": "={{ $( \'Aggregate \').item.json.messages[0].messagesCount }}", "rightValue": 0, "operator": { "type": "number", "operation": "equals" } } ], "combinator": "and" }, "options": {} }, "id": "a9965091-0031-4a7d-a0d3-bf6d0d980700", "name": "Is empty", "type": "n8n-nodes-base.if", "typeVersion": 2.1, "position": [ 2720, 380 ] }, { "parameters": { "rules": { "values": [ { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" }, "conditions": [ { "leftValue": "={{ $( \'When chat message received \').isExecuted }}", "rightValue": "", "operator": { "type": "boolean", "operation": "true", "singleValue": true } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "chat" }, { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" }, "conditions": [ { "id": "0ea22d68-47d5-49bc-ae6c-3f3e24c717c0", "leftValue": "={{ $( \'WhatsApp Trigger \').isExecuted }}", "rightValue": "", "operator": { "type": "boolean", "operation": "true", "singleValue": true } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "whatsapp" } ] }, "options": {} }, "id": "a46668d6-ca25-4727-b3a3-11acbb42593d", "name": "is chat or whatsapp1", "type": "n8n-nodes-base.switch", "typeVersion": 3.1, "position": [ 2980, -40 ] }, { "parameters": { "assignments": { "assignments": [ { "id": "23a29947-2bc1-46c4-964a-764493ebe051", "name": "output", "value": "[12/09/2024 22:36:54] ‪+1 (555) 026‑4737‬: Bienvenue sur le calculateur de score d \'immunité [12/09/2024 22:36:54] ‪+1 (555) 026‑4737‬: Je vais vous poser quelques questions pour calculer votre score d \'immunité en fonction de vos pratiques sur la route. Ce score va de 0 (comportement dangereux) à 100 (conduite exemplaire).", "type": "string" } ] }, "options": {} }, "id": "e0c68b2f-920d-4e06-b28d-e497fbe5dc68", "name": "send response", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ 3280, -140 ] }, { "parameters": { "assignments": { "assignments": [ { "id": "fe0328b1-8ae0-4697-85d6-71c0f98184c8", "name": "chatInput", "value": "={{ ($json.messages[0].text)?$json.messages[0].text.body:undefined || ($json.messages[0].interactive)?$json.messages[0].interactive.button_reply.id:undefined || ($json.messages[0].button)?$json.messages[0].button.text:undefined }}", "type": "string" }, { "id": "04dc70cb-c402-4b14-aaa0-fe98c86a09cb", "name": "sessionId", "value": "={{ $json.contacts[0].wa_id }}", "type": "string" } ] }, "options": {} }, "id": "1f3d73c6-88e5-49a9-9f08-fbe934721d65", "name": "get message input", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ 1340, 340 ] }, { "parameters": { "assignments": { "assignments": [ { "id": "0de41171-6166-49e4-9310-37d56411d0f7", "name": "sessionId", "value": "={{ $json.sessionId }}", "type": "string" }, { "id": "1ab579e9-fb46-496b-9f26-f7a9b848ccd2", "name": "chatInput", "value": "={{ $json.chatInput }}", "type": "string" } ] }, "options": {} }, "id": "a3408710-a5b0-4bfa-9ecd-2b507e519ced", "name": "get inputs", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ 1560, 460 ] }, { "parameters": { "method": "POST", "url": "https://graph.facebook.com/v20.0/171056489425238/messages", "authentication": "predefinedCredentialType", "nodeCredentialType": "whatsAppApi", "sendBody": true, "specifyBody": "json", "jsonBody": "={\n \"messaging_product\": \"whatsapp\",\n \"status\": \"read\",\n \"message_id\": \"{{ $( \'WhatsApp Trigger \').item.json.messages[0].id }}\"\n }", "options": {} }, "id": "aaabfa89-7681-44b6-a01e-4886d5fc3225", "name": "update message status", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4.2, "position": [ 1640, 140 ], "credentials": { "whatsAppApi": { "id": "cFAp6Z0Ee98kLpVY", "name": "WhatsApp account" } } }, { "parameters": { "rules": { "values": [ { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" }, "conditions": [ { "leftValue": "={{ $json.chatInput.toLowerCase() }}", "rightValue": "reset", "operator": { "type": "string", "operation": "equals" } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "reset" }, { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" }, "conditions": [ { "id": "e4d2ac69-3826-4a7c-8bba-6f5d76757088", "leftValue": "={{ $json.chatInput.toLowerCase() }}", "rightValue": "commencer", "operator": { "type": "string", "operation": "equals", "name": "filter.operator.equals" } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "commencer" } ] }, "options": { "fallbackOutput": "extra" } }, "id": "8b7a00a1-a62a-4967-8a96-bc97fad20bb2", "name": "Switch reset, start, other", "type": "n8n-nodes-base.switch", "typeVersion": 3.1, "position": [ 1720, 460 ] }, { "parameters": { "options": {} }, "id": "55caa291-232f-4b82-9e68-830cbc0cd393", "name": "Get Message history", "type": "@n8n/n8n-nodes-langchain.memoryManager", "typeVersion": 1.1, "position": [ 2180, 380 ] }, { "parameters": { "sessionIdType": "customKey", "sessionKey": "={{ ($( \'get inputs \').isExecuted)?$( \'get inputs \').item.json.sessionId:\"33681682532\" }}", "contextWindowLength": 15 }, "id": "da3089e9-688b-416e-9f0b-77bba46d541f", "name": "Buffer Memory", "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow", "typeVersion": 1.2, "position": [ 2200, 700 ] }, { "parameters": { "content": "## First message with user\nSend welcome template", "height": 391.3175347568978, "width": 664.5962836692197, "color": 2 }, "id": "64d7324b-b0c8-439e-87c0-24f452e16f79", "name": "Sticky Note", "type": "n8n-nodes-base.stickyNote", "typeVersion": 1, "position": [ 2840, -200 ] }, { "parameters": { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" }, "conditions": [ { "id": "2d1b6854-9d52-4c83-87c4-75e6b4553724", "leftValue": "={{ $json.output[ \'prochaine question \'] }}", "rightValue": "=", "operator": { "type": "string", "operation": "exists", "singleValue": true } } ], "combinator": "and" }, "options": {} }, "id": "252e0532-21f1-49ac-bbd5-98ebabaafab2", "name": "If next question", "type": "n8n-nodes-base.if", "typeVersion": 2.1, "position": [ 3360, 380 ] }, { "parameters": { "mode": "insert", "messages": { "messageValues": [ { "type": "user", "message": "={{ $( \'get inputs \').item.json.chatInput }}" }, { "type": "ai", "message": "={{ $json.output[ \'prochaine question \'] }}" }, { "message": "={{ $json.output.score.toString() }}" } ] } }, "id": "41384ae7-9d85-45aa-9f3b-f91b5f7a46d3", "name": "Save in history", "type": "@n8n/n8n-nodes-langchain.memoryManager", "typeVersion": 1.1, "position": [ 3580, 340 ] }, { "parameters": { "jsonSchemaExample": "{\"score\":50, \"prochaine question\":\"comment circules-tu le plus souvent ?\", \"suggestions\": [\"en voiture\", \"à vélo\", \"en trottinette\", \"piéton\"], \"reponse\": \"reponse à la question de l \'utilisateur\", \"recommandations\": \"recommandation pour améliorer son score\"}" }, "id": "40a621df-ee4f-40db-ba70-58600b65be60", "name": "Check output format", "type": "@n8n/n8n-nodes-langchain.outputParserStructured", "typeVersion": 1.2, "position": [ 3160, 580 ] }, { "parameters": { "assignments": { "assignments": [ { "id": "9768aa1e-c991-4535-bc2e-f81731564848", "name": "output", "value": "=score final: {{ $json.output.score.toString() }}", "type": "string" }, { "id": "249d8ead-4f8d-478d-a7d5-cab5826ab31c", "name": "score", "value": "={{ $json.output.score }}", "type": "string" }, { "id": "c6a85c5a-98ab-44ca-94e2-3bd8350883e1", "name": "recommandations", "value": "={{ $json.output.recommandations }}", "type": "string" }, { "id": "01fb8870-bc18-43fd-b6d4-946d5a1bc0e2", "name": "response", "value": "={{ $json.output.reponse }}", "type": "string" } ] }, "options": {} }, "id": "08cbc500-92a9-460c-add9-8613e9aa73cb", "name": "Set variables1", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ 3939, 660 ] }, { "parameters": { "assignments": { "assignments": [ { "id": "24f9383c-f285-4449-9a86-7a84aeddb293", "name": "output", "value": "=score : {{ $( \'Ask LLM \').item.json.output.score }}\n\nprochaine question : {{ $( \'Ask LLM \').item.json.output[ \'prochaine question \'] }}\\n\n\nsuggestions : {{ $( \'Ask LLM \').item.json.output.suggestions }}", "type": "string" }, { "id": "2f9a1af3-edbe-44a6-a4b1-5180fdd9e688", "name": "score", "value": "={{ $( \'Ask LLM \').item.json.output.score }}", "type": "string" }, { "id": "69dc9877-bb90-4186-bb63-36814b079309", "name": "question", "value": "={{ $( \'Ask LLM \').item.json.output[ \'prochaine question \'] }}", "type": "string" }, { "id": "02e33a74-c112-4281-a63a-78841db62894", "name": "suggestions", "value": "={{ $( \'Ask LLM \').item.json.output.suggestions }}", "type": "array" } ] }, "options": {} }, "id": "a2a78dcf-1936-4cff-96b4-2897bb267e89", "name": "Set variables", "type": "n8n-nodes-base.set", "typeVersion": 3.3, "position": [ 3939, 360 ] }, { "parameters": { "assignments": { "assignments": [ { "id": "2778a9e7-fdd9-462e-afcd-c0e4bc3bb8da", "name": "output", "value": "Comment circules-tu le plus souvent ?en voiture, à vélo, en trottinette, piéton", "type": "string" }, { "id": "bb67ada6-7c6e-4db6-85f3-be9db075388f", "name": "score", "value": "50", "type": "string" }, { "id": "c3240ff4-a4f7-4b52-9945-d501c72af168", "name": "question", "value": "Comment circules-tu le plus souvent ?", "type": "string" }, { "id": "a2b330a9-db14-465d-942c-4edfba1a3ef6", "name": "suggestions", "value": "[\"en voiture\", \"à vélo\", \"en trottinette\", \"piéton\"]", "type": "array" } ] }, "options": {} }, "id": "0f8f8a44-7deb-4414-a2ff-b4c76822a005", "name": "Set variables2", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ 3939, 1020 ] }, { "parameters": { "mode": "insert", "insertMode": "override", "messages": { "messageValues": [ { "message": "50" }, { "type": "ai", "message": "comment circules-tu le plus souvent ?" } ] } }, "id": "83450e88-0625-4820-9653-842f000be29e", "name": "Reset History", "type": "@n8n/n8n-nodes-langchain.memoryManager", "typeVersion": 1.1, "position": [ 2440, 1029 ] }, { "parameters": { "content": "## Reset \nUser asked to start or restart scoring", "height": 269.71471291811474, "width": 1779.1861174599298, "color": 7 }, "id": "f316a0ba-d3db-4447-b288-c7516f12816a", "name": "Sticky Note1", "type": "n8n-nodes-base.stickyNote", "typeVersion": 1, "position": [ 2280, 940 ] }, { "parameters": { "rules": { "values": [ { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" }, "conditions": [ { "leftValue": "={{ $json.suggestions }}", "rightValue": "", "operator": { "type": "array", "operation": "notEmpty", "singleValue": true } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "question with suggestion" }, { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" }, "conditions": [ { "id": "ceb64f4d-ccdb-4798-ab90-429f94dacb44", "leftValue": "={{ $json.question }}", "rightValue": "", "operator": { "type": "string", "operation": "notEmpty", "singleValue": true } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "question" }, { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" }, "conditions": [ { "id": "ac152113-a24c-4fe2-b5a1-326fc65865c4", "leftValue": "={{ $json.response }}", "rightValue": "", "operator": { "type": "string", "operation": "notEmpty", "singleValue": true } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "response" } ] }, "options": { "fallbackOutput": "extra" } }, "id": "6d7f40f6-6d94-4bda-9c14-596f7f040c85", "name": "repsonse type", "type": "n8n-nodes-base.switch", "typeVersion": 3.1, "position": [ 4679, 760 ] }, { "parameters": { "mode": "raw", "jsonOutput": "={\n \"action\": {\n \"buttons\": {{ $( \'Merge \').item.json.suggestions.slice(0,3).map((s,i) => {\n return {\n \"type\": \"reply\",\n \"reply\": {\n \"id\": s,\n \"title\": s.slice(-20)\n }\n };\n}) }}\n }\n}", "options": {} }, "id": "e3c3d626-01ec-48c0-bef5-7a3f92577b37", "name": "Create actions boutons", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ 4879, 640 ] }, { "parameters": { "mode": "raw", "jsonOutput": "={\n \"messaging_product\": \"whatsapp\",\n \"recipient_type\": \"individual\",\n \"to\": \"{{ $( \'WhatsApp Trigger \').item.json.contacts[0].wa_id }}\",\n \"type\": \"interactive\",\n \"interactive\": {\n \"type\":\"button\",\n \"header\":{\n \"type\": \"image\",\n \"image\": {\n \"link\": \"{{ \"https://analyses.blob.core.windows.net/boussole-images/img-\"+(1+Math.floor(Math.random()*4))+\".jpg\" }}\"\n } \n },\n \"body\": {\n \"text\": \"*Score : {{ $( \'Merge \').item.json.score}}* \\n\\n ({{ $( \'Merge \').item.json.recommandations || \"Voulez-vous continuer ?\" }})\"\n },\n \"action\":{\n \"buttons\": [{\n \"type\": \"reply\",\n \"reply\": {\n \"id\": \"pose moi encore des questions\",\n \"title\": \"Continuer\"\n }\n },{\n \"type\": \"reply\",\n \"reply\": {\n \"id\": \"commencer\",\n \"title\": \"Recommencer\"\n }\n }]\n }\n }\n}", "options": {} }, "id": "3da222b0-fc23-4674-8a74-8be79e69baeb", "name": "set result body", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ 4880, 1020 ] }, { "parameters": { "method": "POST", "url": "https://graph.facebook.com/v20.0/171056489425238/messages", "authentication": "predefinedCredentialType", "nodeCredentialType": "whatsAppApi", "sendBody": true, "specifyBody": "json", "jsonBody": "={{ $json }}", "options": {} }, "id": "6b64d019-3d33-4a74-b4c1-42a920fe80df", "name": "Send Response to WhatsApp", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4.2, "position": [ 5359, 740 ], "credentials": { "whatsAppApi": { "id": "cFAp6Z0Ee98kLpVY", "name": "WhatsApp account" } } }, { "parameters": { "content": "## Format response", "height": 1064.3093461189917, "width": 1776.54583803182 }, "id": "3a8e9b06-140c-4d17-a5db-c2aa8d030d51", "name": "Sticky Note2", "type": "n8n-nodes-base.stickyNote", "typeVersion": 1, "position": [ 3900, 220 ] }, { "parameters": { "content": "## Request LLM", "height": 561.4904073678398, "width": 1735.073802674527 }, "id": "318c4280-affb-4d81-8c7e-d5df82f1bc75", "name": "Sticky Note3", "type": "n8n-nodes-base.stickyNote", "typeVersion": 1, "position": [ 2120, 280 ] }, { "parameters": { "content": "## Get message data", "height": 538.0406114665105, "width": 1149.3396349007437 }, "id": "ccc8a472-849a-4e68-9cdd-370b010022c7", "name": "Sticky Note4", "type": "n8n-nodes-base.stickyNote", "typeVersion": 1, "position": [ 840, 320 ] }, { "parameters": { "content": "## Update message status", "height": 213.53205431571206, "width": 339.41667230060784, "color": 2 }, "id": "db1c4368-264c-4ad0-a0d5-5773805dd58c", "name": "Sticky Note5", "type": "n8n-nodes-base.stickyNote", "typeVersion": 1, "position": [ 1540, 80 ] }, { "parameters": { "path": "6ca7fc09-98a2-4996-8293-22026d70d14d", "responseMode": "lastNode", "options": {} }, "id": "91601e61-c589-4e7d-adfe-20e5190c6b08", "name": "Webhook", "type": "n8n-nodes-base.webhook", "typeVersion": 2, "position": [ 960, 700 ], "webhookId": "6ca7fc09-98a2-4996-8293-22026d70d14d" }, { "parameters": { "assignments": { "assignments": [ { "id": "b08b1860-5dc7-4fc0-bed7-312055003dee", "name": "chatInput", "value": "={{ $json[\"query\"][\"chatInput\"] }}", "type": "string" }, { "id": "6d2a0006-57da-4886-bed9-d3b8fad9c930", "name": "sessionID", "value": "={{ $json[\"query\"][\"sessionId\"] }}", "type": "string" } ] }, "options": {} }, "id": "dbafe134-26b2-45b6-8fcc-34f7fd6ae818", "name": "Edit Fields", "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ 1180, 700 ] }, { "parameters": { "rules": { "values": [ { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" }, "conditions": [ { "leftValue": "={{ $( \'When chat message received \').isExecuted || $( \'Webhook \').isExecuted }}", "rightValue": "", "operator": { "type": "boolean", "operation": "true", "singleValue": true } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "chat" }, { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" }, "conditions": [ { "id": "0ea22d68-47d5-49bc-ae6c-3f3e24c717c0", "leftValue": "={{ $( \'WhatsApp Trigger \').isExecuted }}", "rightValue": "", "operator": { "type": "boolean", "operation": "true", "singleValue": true } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "whatsapp" } ] }, "options": {} }, "id": "cf5ffeb5-22e9-44a5-a24b-59c67161aeb1", "name": "is chat or whatsapp", "type": "n8n-nodes-base.switch", "typeVersion": 3.1, "position": [ 4439, 640 ] }, { "parameters": { "method": "POST", "url": "https://graph.facebook.com/v20.0/171056489425238/messages", "authentication": "predefinedCredentialType", "nodeCredentialType": "whatsAppApi", "sendBody": true, "specifyBody": "json", "jsonBody": "={\n \"messaging_product\": \"whatsapp\",\n \"recipient_type\": \"individual\",\n \"to\": \"{{ $( \'WhatsApp Trigger \').item.json.contacts[0].wa_id }}\",\n \"type\": \"interactive\",\n \"interactive\": {\n \"type\":\"button\",\n \"header\":{\n \"type\": \"image\",\n \"image\": {\n \"id\": \"1745548432885818\"\n } \n },\n \"footer\": {\n \"text\":\"La Boussole by Association Antoine Alléno\"\n },\n \"body\": {\n \"text\": \"*Bienvenue {{ $( \'WhatsApp Trigger \').item.json.contacts[0].profile.name || \"\" }} sur le calculateur de score d \'immunité*\\nJe vais vous poser quelques questions pour calculer votre score d \'immunité en fonction de vos pratiques sur la route. Ce score va de 0 (comportement dangereux) à 100 (conduite exemplaire).\"\n },\n \"action\":{\n \"buttons\": [{\n \"type\": \"reply\",\n \"reply\": {\n \"id\": \"commencer\",\n \"title\": \"Commencer\"\n }\n }]\n }\n }\n}", "options": {} }, "id": "10727876-b920-409e-8b2f-ebda346b2008", "name": "Send Welcome message", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4.2, "position": [ 3280, 20 ], "credentials": { "whatsAppApi": { "id": "cFAp6Z0Ee98kLpVY", "name": "WhatsApp account" } } }, { "parameters": { "promptType": "define", "text": "={{ $( \'get inputs \').item.json.chatInput }}", "hasOutputParser": true, "messages": { "messageValues": [ { "message": "Tu es un interviewer qui cherche à calculer un \"score d \'immunité\" de l \'utilisateur en le questionnant sur ses pratiques à risque sur la route en posant une dizaine de questions. \nLe score d \'immunité est calculé de 0 (très dangereux) à 100 (très précautionneux) et démarre à 50 (comportement moyen de la population). \nPose entre 10 et 20 questions maximum. Si l \'utilisateur te demande son score, renvoie le et fini le test.\nTu suggérera des réponses courtes possibles à tes questions. Ces réponses ne feront pas plus de 20 caractères.\nA chaque nouvelle question, tu retournes le score, mis à jour à partir des informations précédentes.\nTu ne dois jamais poser à nouveau une question qui a déjà été posée dans notre historique.\nLorsque tu enverras le résultat du test, envoie également des recommandations d \'amélioration liées aux réponses que tu as reçu.\n## Format de retour à respecter impérativement\nAttention : Ne retourne que les données au format demandé, sans intégrer d \'autre texte.\nExemple de retour: {\"output\":{\"score\":50, \"prochaine question\":\"comment circules-tu le plus souvent ?\", \"suggestions\": [\"en voiture\", \"à vélo\", \"en trottinette\", \"piéton\"]}}\nQuand tu as fini le questionnaire, retourne le dernier score sous la forme : {\"output\":{\"score\":50, \"recommandations\": \"Un court texte contenant des suggestions pour améliorer le score\"}}\nSi l \'utilisateur te pose une question ou demande une présicion, tu peux y répondre avec ce format : {\"output\":{\"score\":50, \"reponse\":\"la réponse à la question de l \'utilisateur\"}}" }, { "message": "=## Score actuel : {{ ($( \'Aggregate \').item.json.messages[0].messagesCount == 0 )? 50 : $( \'Aggregate \').item.json.messages[0].messages.last().system }}\n## Notre conversation jusqu \'ici:\n{{ $( \'Aggregate \').item.json.messages[0].messages.map(m => {\nlet ret = (m.human)?\"Human: \"+m.human:\"\";\nret += (ret)?`\n`:\"\";\nret += (m.ai) ? \"AI Assistant: \"+m.ai : \"\";\nret += (ret)?`\n`:\"\";\nreturn ret;\n}) }}" } ] } }, "id": "9c6c415f-5e32-4eac-8ae8-4bb01b9c82ff", "name": "Ask LLM", "type": "@n8n/n8n-nodes-langchain.chainLlm", "typeVersion": 1.4, "position": [ 2980, 380 ], "retryOnFail": true, "waitBetweenTries": 100 } ], "connections": { "Azure OpenAI Chat Model": { "ai_languageModel": [ [ { "node": "Ask LLM", "type": "ai_languageModel", "index": 0 } ] ] }, "Aggregate": { "main": [ [ { "node": "Is empty", "type": "main", "index": 0 } ] ] }, "WhatsApp Trigger": { "main": [ [ { "node": "Is message?", "type": "main", "index": 0 } ] ] }, "When chat message received": { "main": [ [ { "node": "get inputs", "type": "main", "index": 0 } ] ] }, "Merge": { "main": [ [ { "node": "is chat or whatsapp", "type": "main", "index": 0 } ] ] }, "set interactive body": { "main": [ [ { "node": "Send Response to WhatsApp", "type": "main", "index": 0 } ] ] }, "Set simple body": { "main": [ [ { "node": "Send Response to WhatsApp", "type": "main", "index": 0 } ] ] }, "Is message?": { "main": [ [ { "node": "get message input", "type": "main", "index": 0 } ] ] }, "Is empty": { "main": [ [ { "node": "is chat or whatsapp1", "type": "main", "index": 0 } ], [ { "node": "Ask LLM", "type": "main", "index": 0 } ] ] }, "is chat or whatsapp1": { "main": [ [ { "node": "send response", "type": "main", "index": 0 } ], [ { "node": "Send Welcome message", "type": "main", "index": 0 } ] ] }, "get message input": { "main": [ [ { "node": "get inputs", "type": "main", "index": 0 }, { "node": "update message status", "type": "main", "index": 0 } ] ] }, "get inputs": { "main": [ [ { "node": "Switch reset, start, other", "type": "main", "index": 0 } ] ] }, "Switch reset, start, other": { "main": [ [ { "node": "Reset History", "type": "main", "index": 0 } ], [ { "node": "Reset History", "type": "main", "index": 0 } ], [ { "node": "Get Message history", "type": "main", "index": 0 } ] ] }, "Get Message history": { "main": [ [ { "node": "Aggregate", "type": "main", "index": 0 } ] ] }, "Buffer Memory": { "ai_memory": [ [ { "node": "Get Message history", "type": "ai_memory", "index": 0 }, { "node": "Save in history", "type": "ai_memory", "index": 0 }, { "node": "Reset History", "type": "ai_memory", "index": 0 } ] ] }, "If next question": { "main": [ [ { "node": "Save in history", "type": "main", "index": 0 } ], [ { "node": "Set variables1", "type": "main", "index": 0 } ] ] }, "Save in history": { "main": [ [ { "node": "Set variables", "type": "main", "index": 0 } ] ] }, "Check output format": { "ai_outputParser": [ [ { "node": "Ask LLM", "type": "ai_outputParser", "index": 0 } ] ] }, "Set variables1": { "main": [ [ { "node": "Merge", "type": "main", "index": 0 } ] ] }, "Set variables": { "main": [ [ { "node": "Merge", "type": "main", "index": 0 } ] ] }, "Set variables2": { "main": [ [ { "node": "Merge", "type": "main", "index": 0 } ] ] }, "Reset History": { "main": [ [ { "node": "Set variables2", "type": "main", "index": 0 } ] ] }, "repsonse type": { "main": [ [ { "node": "Create actions boutons", "type": "main", "index": 0 } ], [ { "node": "Set simple body", "type": "main", "index": 0 } ], [ { "node": "Set simple body", "type": "main", "index": 0 } ], [ { "node": "set result body", "type": "main", "index": 0 } ] ] }, "Create actions boutons": { "main": [ [ { "node": "set interactive body", "type": "main", "index": 0 } ] ] }, "set result body": { "main": [ [ { "node": "Send Response to WhatsApp", "type": "main", "index": 0 } ] ] }, "Webhook": { "main": [ [ { "node": "Edit Fields", "type": "main", "index": 0 } ] ] }, "Edit Fields": { "main": [ [ { "node": "get inputs", "type": "main", "index": 0 } ] ] }, "is chat or whatsapp": { "main": [ [], [ { "node": "repsonse type", "type": "main", "index": 0 } ] ] }, "Ask LLM": { "main": [ [ { "node": "If next question", "type": "main", "index": 0 } ] ] } }, "settings": { "executionOrder": "v1", "timezone": "Europe/Paris", "saveManualExecutions": true, "callerPolicy": "workflowsFromSameOwner" }, "staticData": null, "meta": { "templateCredsSetupCompleted": true }, "pinData": {}, "versionId": "4096fad2-7434-4eba-a257-16c39f75e35a", "triggerCount": 5, "shared": [ { "createdAt": "2024-10-03T13:59:06.319Z", "updatedAt": "2024-10-03T13:59:06.319Z", "role": "workflow:owner", "workflowId": "mPGQR5huFoxKGLyt", "projectId": "rIUrVMkwHWHswdrU", "project": { "createdAt": "2024-10-03T09:05:50.586Z", "updatedAt": "2024-10-03T14:01:55.890Z", "id": "rIUrVMkwHWHswdrU", "name": "La Boussole", "type": "team", "projectRelations": [ { "createdAt": "2024-10-03T14:01:55.902Z", "updatedAt": "2024-10-03T14:01:55.902Z", "role": "project:admin", "userId": "a23ceb33-e4c2-46f0-b13e-26fef5b389d3", "projectId": "rIUrVMkwHWHswdrU", "user": { "createdAt": "2024-06-26T12:43:58.466Z", "updatedAt": "2024-09-17T13:36:40.542Z", "id": "a23ceb33-e4c2-46f0-b13e-26fef5b389d3", "email": "claire@interrest.fr", "firstName": "Claire", "lastName": "Champourlier", "personalizationAnswers": null, "settings": { "userActivated": true, "isOnboarded": true, "firstSuccessfulWorkflowId": "vyvaWt65atWl7IRy", "userActivatedAt": 1719567463445 }, "role": "global:owner", "disabled": false, "mfaEnabled": false, "isPending": false, "isOwner": true } }, { "createdAt": "2024-10-03T14:01:55.902Z", "updatedAt": "2024-10-03T14:01:55.902Z", "role": "project:editor", "userId": "4e80a115-c2da-406b-816a-d6aef0a44ade", "projectId": "rIUrVMkwHWHswdrU", "user": { "createdAt": "2024-06-27T12:14:40.728Z", "updatedAt": "2024-06-28T17:42:27.745Z", "id": "4e80a115-c2da-406b-816a-d6aef0a44ade", "email": "cc@associationantoinealleno.fr", "firstName": "C", "lastName": "Champourlier", "personalizationAnswers": null, "settings": null, "role": "global:member", "disabled": false, "mfaEnabled": false, "isPending": false, "isOwner": false } } ] } } ], "tags": [ { "createdAt": "2024-10-10T09:14:02.752Z", "updatedAt": "2024-10-10T09:14:02.752Z", "id": "C9xETLyHBgmXjFmo", "name": "boussole" } ]}'></n8n-demo>
</body>
</html>
